#!/bin/bash

set -e

if [ $# -eq 0 ]; then
  echo "Usage: $0 <result-file1.json> [result-file2.json ...]"
  exit 1
fi

COMMIT_SHA="${CI_COMMIT_SHA:-$(git rev-parse HEAD)}"
BRANCH_NAME="${CI_BRANCH_NAME:-$(git rev-parse --abbrev-ref HEAD)}"
BASE_BRANCH="${CI_BASE_BRANCH}"
BASE_URL="https://kgyrtkirk.github.io/druid-bench/benchmark-results"

echo "Renaming and uploading benchmark results..."
for JSON_FILE in "$@"; do
  if [ ! -f "$JSON_FILE" ]; then
    echo "Warning: File not found: $JSON_FILE"
    continue
  fi

  # Extract suite name from path: benchmark-results/{suite-name}/{suite-name}.json
  SUITE_NAME=$(basename "$(dirname "$JSON_FILE")")
  SUITE_DIR=$(dirname "$JSON_FILE")

  # Rename from {suite-name}.json to {commit-sha}.json
  RENAMED_FILE="${SUITE_DIR}/${COMMIT_SHA}.json"
  mv "$JSON_FILE" "$RENAMED_FILE"

  echo "Uploading ${SUITE_NAME}..."
  .github/scripts/upload_benchmark_results "$RENAMED_FILE"
done

echo ""
echo "=================================================="
echo "Benchmark results for ${COMMIT_SHA} (${BRANCH_NAME})"
echo ""

for JSON_FILE in "$@"; do
  if [ ! -f "$JSON_FILE" ]; then
    continue
  fi

  # Extract suite name from path: benchmark-results/{suite-name}/{commit-sha}.json
  SUITE_NAME=$(basename "$(dirname "$JSON_FILE")")
  COMMIT_URL="${BASE_URL}/${SUITE_NAME}/${COMMIT_SHA}.json"

  echo "View ${SUITE_NAME}:"
  echo "  https://jmh.morethan.io/?source=${COMMIT_URL}"
  echo ""

  if [ -n "$BASE_BRANCH" ]; then
    BRANCH_URL="${BASE_URL}/${SUITE_NAME}/branch-${BASE_BRANCH}.json"
    echo "Compare ${SUITE_NAME} against base branch (${BASE_BRANCH}):"
    echo "  https://jmh.morethan.io/?sources=${COMMIT_URL},${BRANCH_URL}"
    echo ""

    MERGE_BASE=$(git merge-base HEAD "origin/${BASE_BRANCH}" 2>/dev/null || echo "")
    if [ -n "$MERGE_BASE" ]; then
      MERGE_BASE_URL="${BASE_URL}/${SUITE_NAME}/${MERGE_BASE}.json"
      echo "Compare ${SUITE_NAME} against merge-base (${MERGE_BASE}):"
      echo "  https://jmh.morethan.io/?sources=${COMMIT_URL},${MERGE_BASE_URL}"
      echo ""
    fi
  fi
done

echo "=================================================="
