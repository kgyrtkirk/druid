#!/bin/bash

set -e

should_update_branch_link() {
  local branch_link="$1"
  local new_commit="$2"

  if [ ! -L "$branch_link" ]; then
    return 0
  fi

  local old_target=$(readlink "$branch_link")
  local old_commit=$(basename "$old_target" .json)

  git merge-base --is-ancestor "$old_commit" "$new_commit" 2>/dev/null
}

JSON_FILE="$1"

if [ ! -f "$JSON_FILE" ]; then
  echo "Error: JSON file required and must exist"
  exit 1
fi

if [ -z "$BENCH_REPO_TOKEN" ]; then
  echo "Error: BENCH_REPO_TOKEN environment variable required"
  exit 1
fi

COMMIT_SHA="${CI_COMMIT_SHA:-$(git rev-parse HEAD)}"
BRANCH_NAME="${CI_BRANCH_NAME}"

# Extract suite name from path: benchmark-results/{suite-name}/{commit-sha}.json
SUITE_NAME=$(basename "$(dirname "$JSON_FILE")")

SUITE_DIR="benchmark-results/${SUITE_NAME}"
TARGET_FILE="${SUITE_DIR}/${COMMIT_SHA}.json"
BENCH_REPO="kgyrtkirk/druid-bench"
BENCH_REPO_DIR=".druid-bench"
BENCH_REPO_URL="https://${BENCH_REPO_TOKEN}@github.com/${BENCH_REPO}.git"
JSON_FILE_ABS="$(cd "$(dirname "$JSON_FILE")" && pwd)/$(basename "$JSON_FILE")"

if [ ! -d "$BENCH_REPO_DIR" ]; then
  git clone "$BENCH_REPO_URL" "$BENCH_REPO_DIR"
fi

cd "$BENCH_REPO_DIR"
git pull

mkdir -p "$SUITE_DIR"
cp "$JSON_FILE_ABS" "$TARGET_FILE"
git add "$TARGET_FILE"

if [ -n "$BRANCH_NAME" ]; then
  BRANCH_LINK="${SUITE_DIR}/branch-${BRANCH_NAME}.json"

  if should_update_branch_link "$BRANCH_LINK" "$COMMIT_SHA"; then
    ln -sf "${COMMIT_SHA}.json" "$BRANCH_LINK"
    git add "$BRANCH_LINK"
  fi
fi

git commit -m "Add benchmark results for ${COMMIT_SHA}${BRANCH_NAME:+ (${BRANCH_NAME})} - ${SUITE_NAME}"
git push origin HEAD
