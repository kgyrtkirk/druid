# Method_testGroupByTimeFloorAndDimOnGroupByTimeFloorAndDim case-crc:ead760e9
!set sqlQueryId dummy
!set sqlCurrentTimestamp 2000-01-01T00:00:00Z
!set defaultTimeout 300000
!set maxScatterGatherBytes 9223372036854775807
!set plannerStrategy DECOUPLED
!set debug true
!set outputformat mysql
!use druidtest:///
SELECT dim2, time_floor(gran, 'P1M') gran, sum(s)
FROM (SELECT time_floor(__time, 'P1D') AS gran, dim2, sum(m1) as s FROM druid.foo GROUP BY 1, 2 HAVING sum(m1) > 1) AS x
GROUP BY 1, 2
ORDER BY dim2, gran desc;
+------+---------------------+--------+
| dim2 | gran                | EXPR$2 |
+------+---------------------+--------+
|      | 2001-01-01 00:00:00 |    6.0 |
|      | 2000-01-01 00:00:00 |    2.0 |
|      | 2000-01-01 00:00:00 |    3.0 |
| a    | 2001-01-01 00:00:00 |    4.0 |
| abc  | 2001-01-01 00:00:00 |    5.0 |
+------+---------------------+--------+
(5 rows)

!ok
{
  "queryType" : "groupBy",
  "dataSource" : {
    "type" : "query",
    "query" : {
      "queryType" : "groupBy",
      "dataSource" : {
        "type" : "table",
        "name" : "foo"
      },
      "intervals" : {
        "type" : "intervals",
        "intervals" : [ "-146136543-09-08T08:23:32.096Z/146140482-04-24T15:36:27.903Z" ]
      },
      "virtualColumns" : [ {
        "type" : "expression",
        "name" : "v0",
        "expression" : "timestamp_floor(\"__time\",'P1D',null,'UTC')",
        "outputType" : "LONG"
      } ],
      "granularity" : {
        "type" : "all"
      },
      "dimensions" : [ {
        "type" : "default",
        "dimension" : "v0",
        "outputName" : "d0",
        "outputType" : "LONG"
      }, {
        "type" : "default",
        "dimension" : "dim2",
        "outputName" : "d1",
        "outputType" : "STRING"
      } ],
      "aggregations" : [ {
        "type" : "doubleSum",
        "name" : "a0",
        "fieldName" : "m1"
      } ],
      "having" : {
        "type" : "filter",
        "filter" : {
          "type" : "range",
          "column" : "a0",
          "matchValueType" : "LONG",
          "lower" : 1,
          "lowerOpen" : true
        },
        "finalize" : true
      },
      "limitSpec" : {
        "type" : "NoopLimitSpec"
      }
    }
  },
  "intervals" : {
    "type" : "intervals",
    "intervals" : [ "-146136543-09-08T08:23:32.096Z/146140482-04-24T15:36:27.903Z" ]
  },
  "virtualColumns" : [ {
    "type" : "expression",
    "name" : "v0",
    "expression" : "timestamp_floor(\"d0\",'P1M',null,'UTC')",
    "outputType" : "LONG"
  } ],
  "granularity" : {
    "type" : "all"
  },
  "dimensions" : [ {
    "type" : "default",
    "dimension" : "d1",
    "outputName" : "_d0",
    "outputType" : "STRING"
  }, {
    "type" : "default",
    "dimension" : "v0",
    "outputName" : "_d1",
    "outputType" : "LONG"
  } ],
  "aggregations" : [ {
    "type" : "doubleSum",
    "name" : "_a0",
    "fieldName" : "a0"
  } ],
  "limitSpec" : {
    "type" : "default",
    "columns" : [ {
      "dimension" : "_d0",
      "direction" : "ascending",
      "dimensionOrder" : {
        "type" : "lexicographic"
      }
    }, {
      "dimension" : "_d1",
      "direction" : "descending",
      "dimensionOrder" : {
        "type" : "numeric"
      }
    } ]
  }
}
!nativePlan
